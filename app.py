import streamlit as st
import google.generativeai as genai
from PIL import Image
import yfinance as ticker_info

# 1. ã‚¢ãƒ—ãƒªåŸºæœ¬è¨­å®š
st.set_page_config(page_title="æŠ•è³‡ã‚¢ãƒŠãƒªã‚¹ãƒˆä¼šè­°å®¤", layout="wide")
st.title("ğŸ“ˆ æŠ•è³‡ã‚¢ãƒŠãƒªã‚¹ãƒˆä¼šè­°å®¤ï¼ˆäº‹å®Ÿé‡è¦–ãƒ»å³å¯†åˆ†æç‰ˆï¼‰")

# 2. APIã‚­ãƒ¼ã®è¨­å®š
api_key = st.secrets.get("GEMINI_API_KEY")
if not api_key:
    st.error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Streamlitã®Secretsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# ã€è§£æ±ºã®éµã€‘æ¥ç¶šãƒ«ãƒ¼ãƒˆã‚’æ­£è¦ç‰ˆ(v1)ã«å¼·åˆ¶å›ºå®š
genai.configure(api_key=api_key, transport='rest')

# ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³æŠ‘åˆ¶ã®ãŸã‚ã€æ¨è«–ã®è‡ªç”±åº¦ã‚’æœ€å°ï¼ˆ0ï¼‰ã«è¨­å®š
model = genai.GenerativeModel(
    model_name='gemini-1.5-flash',
    generation_config={
        "temperature": 0.0,
        "top_p": 1,
        "max_output_tokens": 2048,
    }
)

# 3. è³‡é‡‘ç®¡ç†è¨­å®š
with st.sidebar:
    st.header("ğŸ’° è³‡é‡‘ç®¡ç†è¨­å®š")
    total_capital = st.number_input("æŠ•è³‡ç·è³‡é‡‘ (å††)", value=1000000, step=100000)
    risk_per_trade = st.slider("1ãƒˆãƒ¬ãƒ¼ãƒ‰ã®è¨±å®¹ãƒªã‚¹ã‚¯ (%)", 0.1, 5.0, 1.0, 0.1)

# 4. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
uploaded_file = st.file_uploader("ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["png", "jpg", "jpeg"])
symbol = st.text_input("éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (ä¾‹: 7203.T)", value="3315.T")
analyze_button = st.button("å°æ¬¡éƒè¬›å¸«ã«ã€å®¢è¦³çš„åˆ†æã€‘ã‚’ä¾é ¼ã™ã‚‹", type="primary")

# 5. åˆ†æãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾ç­–æ¸ˆã¿ï¼‰
if analyze_button and uploaded_file:
    with st.spinner("ç”»åƒã‹ã‚‰è¦–è¦šçš„ãªäº‹å®Ÿã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™..."):
        try:
            # æœ€æ–°æ ªä¾¡ã‚’äº‹å®Ÿãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦å–å¾—
            stock = ticker_info.Ticker(symbol)
            hist = stock.history(period="1d")
            current_price = hist['Close'].iloc[-1] if not hist.empty else "å–å¾—ä¸å¯"

            # å³å¯†ãªæŒ‡ç¤ºï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            prompt = f"""
            ã‚ãªãŸã¯æŠ•è³‡ã®å°‚é–€å®¶ã€Œå°æ¬¡éƒè¬›å¸«ã€ã§ã™ã€‚
            æä¾›ã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ã€Œç§»å‹•å¹³å‡ç·šå¤§å¾ªç’°åˆ†æã€ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã€å³å¯†ã«åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

            ## å³å®ˆäº‹é …ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
            - ç”»åƒã‹ã‚‰ç›´æ¥ç¢ºèªã§ããªã„æƒ…å ±ï¼ˆéš ã‚ŒãŸæŒ‡æ¨™ã‚„å°†æ¥ã®ä¾¡æ ¼ï¼‰ã‚’ã€Œæ–­å®šã€ã—ãªã„ã§ãã ã•ã„ã€‚
            - åˆ¤åˆ¥ã§ããªã„å ´åˆã¯ã€Œç”»åƒã‹ã‚‰ã¯ä¸æ˜ã€ã¨æ­£ç›´ã«è¿°ã¹ã¦ãã ã•ã„ã€‚
            - æ•°å€¤è¨ˆç®—ã¯ã€æä¾›ã•ã‚ŒãŸäº‹å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆç·è³‡é‡‘ã€ãƒªã‚¹ã‚¯%ã€ç¾åœ¨ä¾¡æ ¼ï¼‰ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

            ## åˆ†ææ‰‹é †
            1. **è¦–è¦šçš„äº‹å®Ÿ**: ç”»åƒã«çŸ­æœŸãƒ»ä¸­æœŸãƒ»é•·æœŸã®3æœ¬ã®ç§»å‹•å¹³å‡ç·šãŒè¦‹ãˆã‚‹ã‹ç¢ºèªã€‚
            2. **ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š**: ç·šã®é‡ãªã‚Šé †ï¼ˆä¸Šã‹ã‚‰é †ã«ä½•ãŒã‚ã‚‹ã‹ï¼‰ã‚’è¨˜è¿°ã—ã€ç¬¬1ã€œç¬¬6ã®ã©ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‹åˆ¤å®šã€‚
            3. **ã‚¨ãƒƒã‚¸ã®ç¢ºèª**: ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«ãŠã‘ã‚‹å„ªä½æ€§ï¼ˆè²·ã„ãƒ»å£²ã‚Šãƒ»ä¼‘ã¿ï¼‰ã‚’è§£èª¬ã€‚
            4. **ãƒ¦ãƒ‹ãƒƒãƒˆè¨ˆç®—**: ç·è³‡é‡‘ {total_capital}å††ã€è¨±å®¹ãƒªã‚¹ã‚¯ {risk_per_trade}%ï¼ˆãƒªã‚¹ã‚¯é¡: {total_capital * (risk_per_trade/100)}å††ï¼‰ã«åŸºã¥ãã€ç¾åœ¨ä¾¡æ ¼ {current_price}å†† ã§ã®æœ€å¤§ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ ªæ•°ã‚’ç®—å‡ºã€‚

            è«–ç†çš„ã‹ã¤èª å®Ÿãªå£èª¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
            """
            
            image = Image.open(uploaded_file)
            # AIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            response = model.generate_content([prompt, image])
            
            st.markdown("---")
            if response.text:
                st.markdown(response.text)
            else:
                st.warning("AIãŒå›ç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç”»åƒãŒé®®æ˜ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            
        except Exception as e:
            st.error("åˆ†æãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
            st.code(str(e))
